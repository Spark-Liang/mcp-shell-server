<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .navbar {
            margin-bottom: 20px;
            background-color: #343a40;
            border-radius: 5px;
        }
        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }
        .card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #6c757d;
            color: white;
            font-weight: bold;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .btn-custom {
            margin-right: 5px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        table {
            width: 100%;
        }
        th {
            background-color: #e9ecef;
        }
        .loading {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 0.25rem solid #f3f3f3;
            border-radius: 50%;
            border-top: 0.25rem solid #3498db;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .log-container {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .log-entry {
            font-family: monospace;
            white-space: pre-wrap;
            margin: 0;
            padding: 0;
        }
        .log-timestamp {
            color: #6c757d;
            font-size: 0.8rem;
        }
        .log-text {
            color: #212529;
        }
        .log-error {
            color: #dc3545;
        }
        .badge {
            margin-right: 5px;
        }
        #refreshRate {
            width: 70px;
            display: inline-block;
        }
        .status-running {
            color: #28a745;
        }
        .status-completed {
            color: #17a2b8;
        }
        .status-failed {
            color: #dc3545;
        }
        .status-terminated {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">MCP Shell Server</a>
            <div>
                <a href="/" class="btn btn-outline-light">Back to Process List</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-5">
                <!-- Process Information Card -->
                <div class="card">
                    <div class="card-header">Process Information</div>
                    <div class="card-body">
                        <div id="loadingInfo" class="text-center">
                            <div class="loading"></div> Loading process information...
                        </div>
                        <div id="processInfo" class="hidden">
                            <h5 id="processTitle" class="card-title">Process Detail</h5>
                            <table class="table table-bordered">
                                <tr>
                                    <th>PID</th>
                                    <td id="pid">{{ pid }}</td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td id="status"></td>
                                </tr>
                                <tr>
                                    <th>Command</th>
                                    <td id="command"></td>
                                </tr>
                                <tr>
                                    <th>Directory</th>
                                    <td id="directory"></td>
                                </tr>
                                <tr>
                                    <th>Description</th>
                                    <td id="description"></td>
                                </tr>
                                <tr>
                                    <th>Labels</th>
                                    <td id="labels"></td>
                                </tr>
                                <tr>
                                    <th>Start Time</th>
                                    <td id="startTime"></td>
                                </tr>
                                <tr>
                                    <th>End Time</th>
                                    <td id="endTime"></td>
                                </tr>
                                <tr>
                                    <th>Exit Code</th>
                                    <td id="exitCode"></td>
                                </tr>
                            </table>
                            <div id="processActions" class="mt-3">
                                <button id="stopBtn" class="btn btn-warning btn-custom">Stop Process</button>
                                <button id="forceStopBtn" class="btn btn-danger btn-custom">Force Stop</button>
                                <button id="cleanBtn" class="btn btn-secondary btn-custom">Clean Process</button>
                            </div>
                        </div>
                        <div id="processError" class="hidden alert alert-danger mt-3"></div>
                    </div>
                </div>
                
                <!-- Output Control Card -->
                <div class="card">
                    <div class="card-header">Output Settings</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="showStdout" checked>
                                <label class="form-check-label" for="showStdout">Show Standard Output</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="showStderr">
                                <label class="form-check-label" for="showStderr">Show Error Output</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="tailLines">Tail Lines:</label>
                            <input type="number" id="tailLines" class="form-control form-control-sm" style="width: 100px; display: inline-block;" value="100" min="1">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoRefresh">
                                <label class="form-check-label" for="autoRefresh">Auto Refresh</label>
                            </div>
                            <div id="refreshControls" class="mt-2 hidden">
                                <label for="refreshRate">Refresh every</label>
                                <select id="refreshRate" class="form-control form-control-sm">
                                    <option value="1">1 sec</option>
                                    <option value="2">2 sec</option>
                                    <option value="5" selected>5 sec</option>
                                    <option value="10">10 sec</option>
                                    <option value="30">30 sec</option>
                                </select>
                            </div>
                        </div>
                        <button id="refreshBtn" class="btn btn-primary">Refresh Output</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-7">
                <!-- Process Output Card -->
                <div class="card">
                    <div class="card-header">Process Output</div>
                    <div class="card-body">
                        <div id="loadingOutput" class="text-center">
                            <div class="loading"></div> Loading process output...
                        </div>
                        <div id="outputContainer" class="hidden">
                            <div id="stdoutContainer" class="log-container">
                                <h6>Standard Output</h6>
                                <div id="stdout"></div>
                            </div>
                            <div id="stderrContainer" class="log-container hidden">
                                <h6>Error Output</h6>
                                <div id="stderr"></div>
                            </div>
                        </div>
                        <div id="outputError" class="hidden alert alert-danger mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Process ID from template
        const pid = {{ pid }};
        
        // Auto-refresh interval ID
        let refreshIntervalId = null;
        
        // On page load
        $(document).ready(function() {
            // Load initial data
            loadProcessInfo();
            loadProcessOutput();
            
            // Set up event handlers
            $("#refreshBtn").click(loadProcessOutput);
            $("#stopBtn").click(() => stopProcess(false));
            $("#forceStopBtn").click(() => stopProcess(true));
            $("#cleanBtn").click(cleanProcess);
            
            // Auto-refresh toggle
            $("#autoRefresh").change(function() {
                if ($(this).is(":checked")) {
                    $("#refreshControls").removeClass("hidden");
                    startAutoRefresh();
                } else {
                    $("#refreshControls").addClass("hidden");
                    stopAutoRefresh();
                }
            });
            
            // Refresh rate change
            $("#refreshRate").change(function() {
                if ($("#autoRefresh").is(":checked")) {
                    stopAutoRefresh();
                    startAutoRefresh();
                }
            });
            
            // Output filter changes
            $("#showStdout, #showStderr").change(updateOutputVisibility);
        });
        
        // Load process information
        function loadProcessInfo() {
            $("#loadingInfo").removeClass("hidden");
            $("#processInfo").addClass("hidden");
            $("#processError").addClass("hidden");
            
            $.ajax({
                url: `/api/process/${pid}`,
                method: "GET",
                success: function(data) {
                    $("#loadingInfo").addClass("hidden");
                    $("#processInfo").removeClass("hidden");
                    
                    // Fill in process details
                    $("#processTitle").text(`Process ${pid}`);
                    
                    // Status with color
                    const status = data.status || "unknown";
                    let statusHtml = `<span class="status-${status.toLowerCase()}">${status}</span>`;
                    $("#status").html(statusHtml);
                    
                    // Command
                    $("#command").text(data.command || "N/A");
                    
                    // Directory
                    $("#directory").text(data.directory || "N/A");
                    
                    // Description
                    $("#description").text(data.description || "N/A");
                    
                    // Labels
                    if (data.labels && data.labels.length > 0) {
                        let labelsHtml = '';
                        data.labels.forEach(label => {
                            labelsHtml += `<span class="badge bg-secondary">${label}</span>`;
                        });
                        $("#labels").html(labelsHtml);
                    } else {
                        $("#labels").text("None");
                    }
                    
                    // Times
                    $("#startTime").text(formatDateTime(data.start_time) || "N/A");
                    $("#endTime").text(formatDateTime(data.end_time) || "N/A");
                    
                    // Exit code
                    $("#exitCode").text(data.exit_code !== null ? data.exit_code : "N/A");
                    
                    // Show/hide buttons based on process status
                    updateActionButtons(status);
                },
                error: function(xhr) {
                    $("#loadingInfo").addClass("hidden");
                    $("#processError")
                        .removeClass("hidden")
                        .text(`Error loading process information: ${xhr.responseJSON?.error || xhr.statusText}`);
                }
            });
        }
        
        // Load process output
        function loadProcessOutput() {
            $("#loadingOutput").removeClass("hidden");
            $("#outputContainer").addClass("hidden");
            $("#outputError").addClass("hidden");
            
            const showStdout = $("#showStdout").is(":checked");
            const showStderr = $("#showStderr").is(":checked");
            const tailLines = $("#tailLines").val();
            
            $.ajax({
                url: `/api/process/${pid}/output`,
                method: "GET",
                data: {
                    stdout: showStdout,
                    stderr: showStderr,
                    tail: tailLines
                },
                success: function(data) {
                    $("#loadingOutput").addClass("hidden");
                    $("#outputContainer").removeClass("hidden");
                    
                    // Process stdout
                    if (showStdout) {
                        const stdoutHtml = formatLogEntries(data.stdout);
                        $("#stdout").html(stdoutHtml || '<p>No standard output available</p>');
                        $("#stdoutContainer").removeClass("hidden");
                    } else {
                        $("#stdoutContainer").addClass("hidden");
                    }
                    
                    // Process stderr
                    if (showStderr) {
                        const stderrHtml = formatLogEntries(data.stderr, true);
                        $("#stderr").html(stderrHtml || '<p>No error output available</p>');
                        $("#stderrContainer").removeClass("hidden");
                    } else {
                        $("#stderrContainer").addClass("hidden");
                    }
                    
                    updateOutputVisibility();
                },
                error: function(xhr) {
                    $("#loadingOutput").addClass("hidden");
                    $("#outputError")
                        .removeClass("hidden")
                        .text(`Error loading process output: ${xhr.responseJSON?.error || xhr.statusText}`);
                }
            });
        }
        
        // Stop process
        function stopProcess(force) {
            if (!confirm(`Are you sure you want to ${force ? 'force ' : ''}stop this process?`)) {
                return;
            }
            
            $.ajax({
                url: `/api/process/${pid}/stop`,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ force: force }),
                success: function(data) {
                    alert(`Process ${force ? 'force ' : ''}stopped successfully.`);
                    loadProcessInfo();
                    loadProcessOutput();
                },
                error: function(xhr) {
                    alert(`Error stopping process: ${xhr.responseJSON?.error || xhr.statusText}`);
                }
            });
        }
        
        // Clean process
        function cleanProcess() {
            if (!confirm("Are you sure you want to clean this process? This will remove all output logs.")) {
                return;
            }
            
            $.ajax({
                url: `/api/process/${pid}/clean`,
                method: "POST",
                success: function(data) {
                    alert("Process cleaned successfully.");
                    // Redirect to process list
                    window.location.href = "/";
                },
                error: function(xhr) {
                    alert(`Error cleaning process: ${xhr.responseJSON?.error || xhr.statusText}`);
                }
            });
        }
        
        // Format log entries
        function formatLogEntries(entries, isError = false) {
            if (!entries || entries.length === 0) {
                return "";
            }
            
            let html = "";
            entries.forEach(entry => {
                const timestamp = entry.timestamp ? new Date(entry.timestamp).toLocaleString() : "";
                const logClass = isError ? "log-error" : "log-text";
                
                html += `<div class="log-entry">`;
                if (timestamp) {
                    html += `<span class="log-timestamp">[${timestamp}]</span> `;
                }
                html += `<span class="${logClass}">${escapeHtml(entry.text)}</span></div>`;
            });
            
            return html;
        }
        
        // Format date/time
        function formatDateTime(dateStr) {
            if (!dateStr) return null;
            return new Date(dateStr).toLocaleString();
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Update output visibility based on checkboxes
        function updateOutputVisibility() {
            const showStdout = $("#showStdout").is(":checked");
            const showStderr = $("#showStderr").is(":checked");
            
            if (showStdout) {
                $("#stdoutContainer").removeClass("hidden");
            } else {
                $("#stdoutContainer").addClass("hidden");
            }
            
            if (showStderr) {
                $("#stderrContainer").removeClass("hidden");
            } else {
                $("#stderrContainer").addClass("hidden");
            }
        }
        
        // Update action buttons based on process status
        function updateActionButtons(status) {
            const isRunning = status.toLowerCase() === "running";
            
            if (isRunning) {
                $("#stopBtn, #forceStopBtn").prop("disabled", false);
                $("#cleanBtn").prop("disabled", true);
            } else {
                $("#stopBtn, #forceStopBtn").prop("disabled", true);
                $("#cleanBtn").prop("disabled", false);
            }
        }
        
        // Start auto-refresh
        function startAutoRefresh() {
            const seconds = parseInt($("#refreshRate").val());
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
            }
            refreshIntervalId = setInterval(() => {
                loadProcessInfo();
                loadProcessOutput();
            }, seconds * 1000);
        }
        
        // Stop auto-refresh
        function stopAutoRefresh() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }
        }
    </script>
</body>
</html> 